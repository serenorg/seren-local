# Seren Browser Phase 7 QA & Security Review (January 31, 2026)

## Verdict
Phase 7 is not ready for production. The runtime does serve the bundled SPA and proxy Gateway traffic, but two release-blocking issues remain: (1) the embedded build can easily ship stale HTML because `build:embed` is a manual step that is never enforced during publish, and (2) the runtime serves `/`/`index.html` with a one-year immutable cache header, so once a user loads the site they will never pick up new releases. Both issues violate the core goal of delivering an always-up-to-date SPA via the runtime.

## Findings
1. **`index.html` cached for a year (Blocker)** – `serveStatic()` sets `Cache-Control: public, max-age=31536000, immutable` for _every_ static response, including `/`/`index.html` (`runtime/src/server.ts:38-73`). Because the root request is handled by `serveStatic` (not `serveSpaFallback`), browsers cache the HTML shell for a year and will never fetch new builds. The fallback path only handles unknown routes; it never runs for the initial load. Result: users remain stuck on the first build they ever downloaded, completely negating the point of pushing updates via `build:embed`.
2. **No guardrail to ensure the SPA is bundled before publishing (Major)** – The new workflow relies on developers to run `pnpm build:embed` manually (`package.json:14-24`). `runtime/package.json`’s `prepublishOnly` runs only `npm run build`, which transpiles the Node server but does not copy the SPA into `runtime/public`. If someone forgets to run `build:embed` (or runs it before building a new SPA), the published npm package serves the previous build—or nothing at all—despite the runtime claiming “Serving app at …”. Phase 7’s goal was a one-command distribution, yet the release process is brittle and undocumented.

## Recommendations
1. Detect when the request path is `/` or `/index.html` and send `Cache-Control: no-cache` (or reuse `serveSpaFallback` for the root) so that browsers always revalidate the HTML shell. Keep the long cache header only for hashed asset files.
2. Make `build:embed` part of the publish pipeline (e.g., add a root-level `prepublishOnly` that runs `pnpm build && pnpm build:embed`, or add a script in `runtime/package.json` that copies `../public` before packaging). Also add a quick runtime start-up check that warns when `runtime/public/index.html` is missing or older than the SPA’s `dist/` timestamp.
3. Document and automate the release steps in CI so `seren` users never receive an empty or stale embedded SPA.

Once these changes are in place (and verified via `npm pack` + a clean install), Phase 7 can be reconsidered for production sign-off.
