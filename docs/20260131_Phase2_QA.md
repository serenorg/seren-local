# Seren Browser Phase 2 QA & Security Review (January 31, 2026)

## Verdict
Phase 2 is not shippable. Although the Node.js runtime boots and exposes a JSON-RPC surface, the browser never takes advantage of the new capabilities: conversation storage is still browser-only, the file explorer cannot open folders, and the runtime exposes unauthenticated file-system primitives to any website running on the user's machine. The phase goals—"local runtime enables ACP/OpenClaw/file access foundation"—remain unmet.

## Functional QA Findings
1. **Runtime conversation storage is never used (Blocker)** – Task 2.5 required `bridge.ts` to route conversation CRUD to SQLite when the runtime is connected. All conversation APIs (`createConversation`, `getConversations`, etc.) still hard-code IndexedDB and never call `runtimeInvoke` (`src/lib/bridge.ts:409-679`). Meanwhile the runtime registers full chat handlers (`runtime/src/handlers/index.ts:12-20`) that are never invoked. Users therefore cannot share history between browsers and the runtime's SQLite database is dead code.
2. **Folder picker RPCs are missing, so the file explorer cannot load a project (Blocker)** – The browser side invokes `runtimeInvoke("open_folder_dialog")`, `open_file_dialog`, `save_file_dialog`, and `reveal_in_file_manager` (e.g. `src/lib/files/service.ts:86-140`, `src/components/sidebar/FileTree.tsx:88-121`), but the runtime only registers basic FS handlers (`runtime/src/handlers/index.ts:5-20`). Because no RPC method named `open_folder_dialog` (or the others) exists, the file explorer throws "Method not found" before a user can select any directory, violating the Phase 2 acceptance criteria "With runtime: file explorer works".
3. **Runtime event bridge never shipped (Major)** – Task 2.2 called for both `rpc.ts` *and* `events.ts`, but the repository contains only `src/rpc.ts`. There is no publish/subscribe channel for ACP/OpenClaw or tool streaming events, so the runtime cannot push notifications back to the SPA. Any future feature (ACP, OpenClaw, file watcher) that depends on runtime-originated events will fail immediately.
4. **Runtime install provides no process lifecycle integration (Major)** – `connectToRuntime()` runs once on mount and never retries after a failure (`src/lib/bridge.ts:80-138`, `src/App.tsx:28-74`). If a user launches the runtime after opening the browser (or it restarts for an update), the SPA never reconnects and continues to report "runtime required" forever. Task 2.4 explicitly called for reconnection logic so file/ACP features could recover automatically.
5. **No automated coverage of SPA↔runtime flows (Minor)** – Phase 2 testing stops at isolated Vitest suites under `runtime/tests/`. There are no Playwright or integration tests that boot the runtime, connect via the bridge, open a folder, or persist a conversation via SQLite. The Final Audit Checklist items "With runtime: file explorer works" and "With runtime: ACP agent spawns" remain unchecked and untestable.

## Security Findings
1. **Any website can talk to the Seren runtime (Critical)** – The WebSocket server blindly accepts every localhost connection (`runtime/src/server.ts:52-71`) and the browser bridge opens a socket with no authentication, CSRF token, or origin pinning (`src/lib/bridge.ts:80-138`). This means a malicious web page can call `new WebSocket("ws://localhost:19420")` and immediately gain the ability to `read_file`, `delete_path`, or dump the SQLite chat database. Phase 2 must include an origin secret (e.g., random auth token, mutual challenge, or checking a signed session cookie) so only the Seren SPA can issue privileged commands.
2. **Path validation is vulnerable to symlink breakout (High)** – `validatePath()` merely checks that the string produced by `path.resolve()` starts with the home directory or tmpdir (`runtime/src/handlers/fs.ts:18-34`). If a user opens `~/projects/malicious-link`, which is a symlink to `/etc`, the resolved string still begins with the home prefix, so the runtime happily reads `/etc/passwd`. The fix is to resolve through `fs.realpath` and compare the canonicalized target against an allow list, or to forbid following symlinks entirely for destructive operations.

## Testing & Verification Gaps
- No end-to-end test spins up the runtime and exercises the WebSocket bridge, so regressions like the missing RPC methods went unnoticed.
- The repo lacks any security regression tests (static or dynamic) around runtime authentication or path sandboxing despite the plan calling for those checks before exit.

## Recommended Remediation
1. Implement proper runtime authentication: generate a random token at runtime startup, display it in the CLI, have the SPA prompt the user, and require that token on every RPC (or reuse the session JWT via mutually authenticated HTTPS). Reject WebSocket connections that do not present the secret and log intrusion attempts.
2. Finish Task 2.5 by teaching `src/lib/bridge.ts` to call the runtime chat handlers when `isRuntimeConnected()` is true, while keeping IndexedDB as the offline fallback. Add Vitest coverage that toggles a mocked runtime connection so this dual mode cannot regress.
3. Implement the missing RPC handlers (`open_folder_dialog`, `open_file_dialog`, `save_file_dialog`, `reveal_in_file_manager`, etc.) or switch the SPA back to browser-native `<input type="file" webkitdirectory>` pickers so users can actually open a workspace in Phase 2.
4. Add the promised runtime event bus (`runtime/src/events.ts`) plus reconnect/backoff logic in the SPA. Emit and listen for a "runtime:connected" event so UI components (file explorer, ACP, OpenClaw) can reinitialize automatically whenever the local daemon comes online.
5. Harden `validatePath()` using `fs.realpath` (and optional `lstat` checks) so symlinks cannot escape the permitted directories, and add unit tests that cover both symlink and hardlink breakout attempts.
6. Create an integration Playwright suite that launches the runtime (or a mocked WebSocket server), opens a folder, writes a file, and verifies that operations succeed only after the runtime authenticates the session.
