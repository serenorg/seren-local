# Seren Browser Phase 1 QA & Security Review (January 31, 2026)

## Verdict
Phase 1 cannot be accepted: the browser SPA still depends on the local runtime for core gateway flows, and OAuth-based authentication is broken end-to-end. Multiple security regressions were also introduced during the migration.

## Functional QA Findings
1. **OAuth flows never complete (Blocker)** – `listenForOAuthCallback` is now a no-op in the browser (`src/lib/bridge.ts:314-318`), yet `ProviderSettings` still relies on it to receive callbacks (`src/components/settings/ProviderSettings.tsx:44-90`). Because nothing fires the callback, the SPA never captures the `code`/`state` pair and cannot store provider credentials. In addition, `startOAuthFlow` opens a new tab (`window.open`) while persisting PKCE state in `sessionStorage` (`src/services/oauth.ts:65-114`), so even if a callback were handled the new tab would not have access to the stored state. Phase 1 exit criterion “OAuth login works (GitHub)” is therefore unmet.
2. **No OAuth callback handler in App.tsx (Blocker)** – Task 1.7 requires parsing `window.location.search` on load and calling `handleOAuthCallback`. The current `onMount` block in `src/App.tsx:33-99` never checks for `code`/`state`, never calls `handleOAuthCallback`, and never clears the URL. Even email/password login success simply toggles `authStore` without verifying tokens. Browser refreshes on `/oauth/callback` will hang indefinitely.
3. **Gateway MCP still requires the runtime (Blocker)** – The HTTP client keeps calling `runtimeInvoke` for every remote MCP action (`connectHttp`, `listToolsHttp`, `callToolHttp`, etc.) as shown in `src/lib/mcp/client.ts:357-460`. Without the runtime process there is no way to reach `mcp.serendb.com`, which contradicts Section 7’s requirement that “All Gateway features work without the local runtime.” The checklist items “Gateway MCP tools appear in catalog” and “Gateway tool execution works” cannot pass.
4. **Publisher OAuth still depends on Tauri-era flows (Major)** – `connectPublisher` hard codes `seren://` and Windows loopback redirects plus the legacy `get_oauth_redirect_url` IPC (`src/services/publisher-oauth.ts:20-56`). This always throws “This operation requires the local runtime to be running” in a pure browser, blocking catalog integrations that Phase 1 promised.
5. **Runtime handshake never runs (Major)** – `connectToRuntime()` is defined in `src/lib/bridge.ts:80-138` but is never imported anywhere (`rg connectToRuntime` only returns the definition). Even if a user manually starts the future Node runtime, the SPA never attempts the WebSocket connection, so features like the file explorer and ACP remain permanently unavailable instead of gracefully upgrading when the runtime appears. Task 1.7 explicitly called for `connectToRuntime()` inside `App.onMount()`.
6. **File explorer context menu bypasses bridge safeguards (Major)** – `src/components/sidebar/FileTree.tsx:1-120` directly calls `runtimeInvoke("read_file" | "rename_path" | "delete_path"...)` without verifying `isRuntimeConnected()` or surfacing a “runtime required” state to users. Clicking context menu actions in browser-only mode throws uncaught promise rejections in the console, violating the plan’s manual check “File explorer shows \"runtime required\" message (or empty state).”

## Security Findings
1. **Authorization codes & states written to logs (High)** – The OAuth callback listener logs the entire callback URL plus boolean flags (`src/components/settings/ProviderSettings.tsx:44-55`). These logs include the authorization `code` and `state`, so any log aggregation system or browser extension sees the one-time secrets. Remove these `console.log` calls or at minimum redact sensitive query params.
2. **MCP OAuth state secret logged (High)** – The MCP OAuth flow logs `callbackResult.state` before verifying it (`src/services/mcp-oauth.ts:605-646`). Logging a CSRF token defeats its purpose and exposes the secret via browser DevTools or remote log sinks. This violates the Security Requirements section (“Never log tokens”).

## Testing & Verification Gaps
- Automated coverage stops at `tests/lib/bridge.test.ts`; there are zero Vitest/Playwright cases for login, OAuth, chat, or MCP flows. Phase 1 promised TDD for the bridge but also requires regression protection for auth and MCP—those suites are missing.
- The manual checklist items in Section “Phase 1 Complete Checklist” (OAuth login, Gateway MCP tools, etc.) cannot be executed successfully given the blockers above and therefore remain unverified.

## Recommended Remediation
1. Re-implement OAuth using same-tab redirects: persist PKCE state in `sessionStorage`, navigate via `window.location.assign`, and add an `onMount` callback handler in `src/App.tsx` that calls `handleOAuthCallback`, stores credentials, and clears the query params.
2. Replace the remaining runtime-dependent browser flows: port `mcpClient` HTTP methods to pure `fetch`, move `connectPublisher` to browser-friendly endpoints, and delete any `seren://` references per Task 1.4/1.6.
3. Invoke `connectToRuntime()` during startup and gate every runtime-only UI (FileTree, ACP, OpenClaw) behind `isRuntimeConnected()` so they either work when the runtime is available or show the explicit “runtime required” state.
4. Purge all OAuth-related logging (Provider settings + MCP OAuth) and add a lint rule or log scan to ensure secrets never hit stdout again.
5. Backfill high-value tests: add a minimal Playwright script that covers email/password login, browser OAuth, sending a chat message, and exercising one Gateway MCP tool so the Phase 1 checklist can run in CI.
